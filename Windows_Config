#Various Powershell commands for installing and configuring a Server core and Server GUI install


#Configure Server core
sconfig

#Powershell AD Join commands 
 
#Check available commands 
Get-command –module ADDSDeployment 
 
#Run Powershell against remote servers 
invoke-command {install-addsdomaincontroller –domainname ethernuno.intra –credential (get-credential) –computername dc02 
 
#Simplest way of Creating a new Forest 
Install-ADDSForest –DomainName "lab.net" 
 
#Customized Configuration  
Install-ADDSForest –DomainName ‘lab.net’ –CreateDNSDelegation –DomainMode Win2012R2 –ForestMode Win2012R2 –DatabasePath "d:\NTDS" –SYSVOLPath "d:\SYSVOL" –LogPath "e:\Logs"
Install-ADDSForest –DomainName $domain –DomainMode Win2012R2 –ForestMode Win2012R2 -Force -SafeModeAdministratorPassword (convertto-securestring $password -asplaintext -force) –DatabasePath $locationNTDS –SYSVOLPath $locationSYSVOL –LogPath $locationNTDSLogs -verbose

#First you MUST install AD Role on Server
Install-Windowsfeature AD-Domain-Services,DNS

#Join an existing Domain this is the replacment for DCPROMO
Install-ADDSDomainController -DomainName 'awssol.com' -InstallDNS:$True –Credential (Get-Credential) 

#CleanUp commands 
Get-help Uninstall-ADDSDomainController 
 
#Demote Commands 
Uninstall-ADDSDomainController –Forceremoval -Demoteoperationmasterrole 
 
######Set TrustedHost this is required to remotely manage a server when both systems are not apart of a Domain##################### 
Set-Item WSMan:\localhost\Client\TrustedHosts -Value ‘hostname,hostname.local’ –Force 
Set-Item WSMan:\localhost\Client\TrustedHosts -Value ‘IP,IP’ –Force

#####Get Trusted Hosts###################################
Get-Item WSMan:\localhost\Client\TrustedHosts

#Get windows features
Get-Windowsfeature
Get-WindowsFeature | more
Get-WindowsFeature -Name AD*, Web*  ##Get all features with AD and web in the name
Get-WindowsFeature | Where Installed #just get installed features
Get-WindowsFeature | Where Installed | Select Name  ##Just give me the names so we can pipe to a file

#Install windows feature
Install-Windowsfeature -Name 'FeatureName' -IncludeAllSubFeature -IncludeManagementTools
Install-Windowsfeature -Name 'FeatureName','FeatureName'

#Disable FireWall You can also do this with a GPO Computer Config>Admin Templates>Network>Network Connections>Windows Firewall
#Advance Firewall settings GPO comouter config>Policies>Windows Swttings>Security Settings>Windows Firewall with Advanced Security
Set-NetFirewallProfile -Profile Domain,Public,Private -Enabled False

#In a virtual environment you will need configure an external time source for your PDC
w32tm.exe /config /manualpeerlist:"0.us.pool.ntp.org 1.us.pool.ntp.org" /syncfromflags:manual /reliable:YES /update
w32tm.exe /config /update
Restart-Service w32time

#Remote Volume Management
#VDS must be running on both the local and remote device, please make certain to open up 'Remote Volume Management' 

#Must register this on each DC so you can move Schema master role
regsvr32 schmmgmt.dll
#Then load mmc.exe and you should now see an options for 'Active Directory Schema'
###I had an odd issue when attempting to transfer to the schema master role, I kept getting an error
##Schema master could not be contacted, to fix I made certain the schema master has an alternate DNS server
##In my case the DNS of the DC I wanted to be the new schema master, ODD!!


################################################################################################################################
Create Bootable USB stick for Server 2012 R2 I will assume this will work for 2016 as well

Pre-requisites: 7-Zip software (Download it from here: http://7-zip.org/), Windows 2012 (R2) ISO (or Windows 8.1 ISO), 8GB or more USB disk

Open Command Prompt in elevated mode (Run as Administrator)
Type diskpart and press Enter
Type list disk and press Enter. Note the list of existing disks.
Insert the USB Disk
Type list disk and press enter again. Note the new disk showed up which is our USB disk. I assume the new disk is 2 for example purpose.
Type select disk X where X is your USB disk. E.g., select disk 2. Press Enter.
Type clean and press enter.
Type create partition primary and press enter to create primary partition 1.
Type select partition 1 and press enter.
Type active and press enter to make the partition 1 active
Type format fs=ntfs and press enter. This will format the partition 1 as NTFS volume.
Type assign and press enter to assign the USB disk to a drive letter.
 

Now right click on Windows Server 2012 R2 or Windows 8.1 ISO file, select 7-Zip –> Extract Files…
Select your USB disk to extract the ISO contents to the USB disk
That’s all. Boot the server or computer using the bootable USB disk.

***Note I simply formatted the USB disk as NTFS in the GUI and then I set the partition as primary
***This also will allow you to upgrade a server instead of doing a clean install
#########################################################################################################################

#####Enable Disk performance metrics under server 2012,windows 10, server 2016, windows 8.1 from command prompt enter
diskperf -Y

###################Windows update tries to update but stops @ updating n%#########################
######This is probably due to a power outage as the VM was doing it's update
##boot into safe mode and run make certain C is the correct drive of your Windows install, in my case it was D
dism.exe /image:D:\ /cleanup-image /revertpendingactions
######You can also attempt to rename the following file
c:\windows\winsxs\pending.xml


################################UPGRADING ROOT CA FROM SHA1 TO SHA256#####################################################
#########THIS IS IF YOU ONLY HAVE A ROOT CA AND YOU DON'T HAVE SUB-CA'S PLEASE REFERENCE https://www.petenetlive.com/KB/Article/0001243
#Launch powershell
certutil -setreg ca\csp\CNGHashAlgorithm SHA256
net stop certsvc
net start certsvc
#########Then Renew your Root Certificate and it should now show SHA256
#####FROM YOU CA "Renew CA Certificate" make certain you select "NO" to "Generate new public and private keys"
########ALSO YOU CAN DO THIS SIMPLY IF YOUR CRYPTOGRAPHIC PROVIDER IS "Microsoft Software Key Storage Provider" again refer to above link
####NOTE YOU MUST RUN GPUPDATE /FORCE SO THE NEW CERTIFICATE CAN REPLICATE TO YOUR ENDPOINTS "TRUSTED ROOT CERTIFICATE AUTHORITY"##
#####ALSO YOU CAN USE THE lpd.exe TOOL TO TEST LDAPS FUNCTUNALITY LDAP PORT:389 LDAPS:636###################


############FORMAT A DISK 8K BLOCK SIZE#########################################################

####This can be done from the GUI or from diskpart
######let's first check our current unit allocation size
##launch elevated command prompt
fsutil fsinfo ntfsinfo 'your drive' 'bytes per cluster is your unit allocation'

######now let's format using diskpart
elevated command prompt
diskpart.exe
list volume or list disk
select volume 'your volume number' or select disk

####You can also create a 500 MB partition if this is your C drive like so

create partition primary size=500
format quick
####this will give you a 500MB partition and then the below will format the rest as 8k block size
create partition primary
format fs=ntfs quick unit=8192 label=data or
format fs=ntfs quick unit=8k label=data

Boot from Windows installation media.
Press Shift+F10 at the first setup screen to open a command prompt.
Run the following commands to create the partitions:
diskpart
list disk [should only see disk 0]
select disk 0
clean all [erase hard disk (slow process)]
create partition primary size=500 [This will set the size of the System Reserved partition to 500MB (Windows10)]
active
format fs=ntfs label=”System Reserved” quick [This performs a quick format of the System Reserved Partition and sets the cluster size to 4096]
create partition primary                        
format fs=ntfs label="OS" quick unit=8192 [This performs a quick format of the OS Partition and sets the cluster size to 8192]
assign
exit
exit
Install OS

########8K BLOCK ON UEFI/EFI SYSTEMS############################################
###REF: https://docs.microsoft.com/en-us/windows-hardware/manufacture/desktop/configure-uefigpt-based-hard-drive-partitions
##Same as above Shif+F10
list disk
select disk x
clean all ##you can just do 'clean' as well
convert gpt
create partition efi size=100
format quick fs=fat32 label="System"
assign
create partition msr size=16 (Microsoft Reserverd partition)
create partition primary
format quick fs=ntfs label="Windows" unit=8192
assign
exit
exit
Install OS


#########CHANGE DEFAULT COMPUTER AND USER OU###########################

##Computer redirect
redircmp ou=ComputersOU,dc=mydomain,dc=com

##User redirect
redirusr ou=UsersOU,dc=mydomain,dc=com

##In my case
redircmp "OU=fbWorkstations,DC=fb,DC=com"

##############################INSTALL .NET FROM DVD#######################################################################
DISM /Online /Enable-Feature /FeatureName:NetFx3 /All /LimitAccess /Source:d:\sources\sxs (D is DVD drive)



#########POWERSHELL FIREWALL CONFIG#######################################
Get-NetFirewallProfile | Select name, enabled
or
Get-NetFirewallProfile

Set-NetFirewallProfile -Profile Domain,Public,Private -Enabled False

##SET ENVIRONMENT VARIABLES#################

Get-ChildItem Env: (List all environment variables)
echo $Env:ProgramFiles (Just list the variable for ProgramFiles)

setx JAVA_HOME "C:\Program Files\Java\jdk1.8.0_121\"
setx path "%path%;%JAVA_HOME%\bin"


############RSOP.MSC REF:https://prajwaldesai.com/modify-group-policy-refresh-interval-windows-computers/###############
##Log on to local pc and run the below
rsop.msc



###WINDOWS UPDATE REBOOT LOOP####
###Wndows continuosly prompt user to reboot machine to apply an update

##Delete the following reg key
HKLM/Software/Microsoft/Windows/CurrentVersion/WindowsUpdate/Auto Update
##Look for "RebootRequired"
#Delete the entire folder
##REF: http://www.squidworks.net/2012/06/solved-always-getting-message-windows-cant-update-important-files-and-services-while-the-system-is-using-them/



#############STEPS FOR LAPS IMPLEMENTATION############################

###Download LAPS from Microsoft###################################

####On a management server install the entire LAPS tool LAPS64.msi(or LAPS32.msi)#######

####SOME USEFUL COMMANDS#########################

Import-Module AdmPwd.PS ##This is required in ISE but not if you are running interactively on the command line
Get-Command -Module AdmPwd.PS

###LETS UPDATE THE SCHEMA####################

Update-AdmPwdADSchema


#########LETS GRANT COMPUTERS THE ABILITY TO UPDATE THERE PASSWORDS###############

Set-AdmPwdComputerSelfPermission -Identity "Computers_OU"
##OR
Set-AdmPwdComputerSelfPermission -OrgUnit "OU=MyComputers,DC=lab,DC=org"

#####LETS SEE WHO HAS RIGHTS TO SEE PASSWORDS
Find-AdmPwdExtendedRights -Identity "Computers_OU"

#####LETS NOW GRANT USERS PERMISSION TO SEE THE PC PASSWORD###########
Set-AdmPwdReadPasswordPermission -Identity "Computers_OU" -AllowedPrincipals "Help_Desk"
##or
Set-AdmPwdReadPasswordPermission -OrgUnit "OU=MyComputers,DC=lab,DC=org" -AllowedPrincipals "Help_Desk"

#####Then setup the GPO to enable ADM under Computer>Policies>Admin Templates>LAPS

####Then deploy LAPS to your client devices#####################




##For scripts to run as SYSTEM make certain domain computers have atleast read and execute rights to the share######################

#######FORCE SYSTEM TO SYNC TIME WITH DC################

net time \\DC_Name_OR_IP /set /y


###################PROPER PERMISSIONS FOR ABE############################
##Grant Read privileges to "This folder only" to "Authenticated Users" to the root folder
###Traverse folder/ execute file
###List folder /read data
##Read attributes
##Read extended attributes
##Read permissions

##Then assign specific rights to the sub-folders


######REPAIRING DAMAGED PROFILE###########################

###Log on to the system by using an administrative user account other than the user account that is experiencing the problem.
##Back up all data in the current user's profile folder if the profile folder still exists, and then delete the profile folder. 
##By default, the profile resides in the following location:%SystemDrive%\Users\UserName
##Click Start, type regedit in the Start Search box, and then press ENTER.

##User Account Control permission If you are prompted for an administrator password or for confirmation, type your password, or click Continue.
##Locate the following registry subkey:HKEY_LOCAL_MACHINE\SOFTWARE\Microsoft\Windows NT\CurrentVersion\ProfileList
##Under the ProfileList subkey, delete the subkey that is named SID.bak. 

Note SID is a placeholder for the security identifier (SID) of the user account that is experiencing the problem. The SID.bak subkey
##should contain a ProfileImagePath registry entry that points to the original profile folder of the user account that is experiencing the problem.
##Exit Registry Editor.
##Log off the system.
##Log on to the system again.
###NOTE IF THE USER LOGS IN AND IS NOT REDIRECTED TRY RUNNING THE OFFLINE FILE FIX AND AFTER REBOOT HAVE THEM LOGIN


##############INSTALL .MSU FILES########################
wusa.exe ps.msu

##silent install
wusa.exe ps.msu /quiet

###Add full path
wusa.exe c:\msu\ps.msu


############AD DATABASE PERFMON COUNTER###################
###To see if your DC is pulling it's DB from RAM and not disk look at the below counter
Database/Database Cache % HIT for lsass(Low hit rate could mean the DC needs more RAM)


##########FIX WSUS SERVER 2012R2 AND ABOVE "NODE ERROR"######################
##This issue is caused by the WSUSAPPPool's memory defaulting to 1.8GB(1843200KB)
##Luanch IIS manager and unser APPPool look for the WSUS apppool and click on "Advanced settings"
###Under "Private Memory Limit(KB) set it to "0" which means unlimited
###This should resolve your isssue
##REF: https://social.technet.microsoft.com/Forums/lync/en-US/7226dc0d-e3c5-40c2-817d-048bb0a74980/error-connection-error-click-reset-server-node-to-try-to-connect-to-the-server-again?forum=winserverwsus


##############EXPORT AND IMPORT DHCP SCOPES FOR MIGRATION REF:http://www.brycematheson.io/how-to-migrate-dhcp-from-windows-server-2008-to-2012-2016/###############

netsh dhcp server export C:\Users\whomever\Desktop\dhcp.txt all ##export scope

netsh dhcp server import C:\Users\whomever\Desktop\dhcp.txt all
####IF YOU RUN THIS FROM THE COMMAND PROMPT AT IT OUTPUTS NOTHING, TRY POWERSHELL ESPECIALLY IF YOUR BACKUP IS
#####IN THE .BAK FORMAT###########


#############SET DISK POLICY POWERSHELL##################################################
Get-StorageSetting | Select-Object NewDiskPolicy  #First let's see the current policy

Set-StorageSetting -NewDiskPolicy OnlineAll  ##Now set the policy


####### DELETE UNWANTED HEALTHY EFI PARTITION#############
##from ad admin cmd or powershell
diskpart
list disk  ###just to see the layout
list partition
select partition 2(or whatever it is)
delete partition override


#########SYSPREP COMMANDS###############

cd c:\Windows\System32\Sysprep
sysprep /oobe /generalize /shutdown



#############Filter username in eventviewer#####################

##Click on filter and then click on the XML tab

<QueryList>
<Query Id="0" Path="Security">
<Select Path="Security">* [EventData[Data[@Name='TargetUserName']='USERNAME']]</Select>
</Query>
</QueryList>


###Filter even more here we are looking for event ID 4771 and the user#####

<QueryList>
  <Query Id="0" Path="Security">
    <Select Path="Security">*[System[(EventID=4771)] and EventData[Data[@Name='TargetUserName'] = 'testuser']]</Select>
  </Query>
</QueryList>

####Filter for events in the last 7 days###################

<QueryList>
  <Query Id="0" Path="Security">
    <Select Path="Security">*[System[TimeCreated[timediff(@SystemTime) &lt;= 604800000]] and EventData[Data[@Name='TargetUserName'] = 'user1'] ]</Select>
  </Query>
</QueryList>



####Force Win10 Server 2016 to re-check WSUS/WindowsUpdate Server###################
##So the issue I have is that if you deploy a new server from a template, there can be a gap
##Before the VM is joined to AD, well in that time Windows would have downloaded updates from
##Windows update, but if you don't want servers in our environment to have newer updates than
##have been approved by your Enteprise how do you force Windows to re-check WSUS after you join it to the
##Domain, well the below one-liner will get you there

(New-Object -ComObject Microsoft.Update.AutoUpdate).DetectNow()


####Location of shares in the registry##################

HKEY_LOCAL_MACHINE subtree, go to the following key:
SYSTEM\CurrentControlSet\Services\LanmanServer\Shares


#######CERTIFICATE AUTO-ENROLLMENT###############################
##REF: https://docs.microsoft.com/en-us/previous-versions/windows/it-pro/windows-server-2008-R2-and-2008/dd379529(v=ws.10)

##Also I had an issue when attempting to enroll a certificate when I added the server to an AD group and gave the group
##enroll rights it would not work, but when I gave the machine enroll rights to the certificate template it worked
##I need to investigate why groups are not working.



###Powershell curl equivalent##############
##More than one way to do this###########


(New-Object System.Net.WebClient).DownloadFile($URL, $filename)

##OR

(New-Object System.Net.WebClient).DownloadFile('http://server/file.js', 'C:\output\file.js')


################BACKUP DHCP SERVER###########################################
netsh dhcp server \\dhcpserver dump > c:\DHCP-config.txt




