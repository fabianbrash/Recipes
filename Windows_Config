#Various Powershell commands for installing and configuring a Server core and Server GUI install


#Configure Server core
sconfig

#Powershell AD Join commands 
 
#Check available commands 
Get-command –module ADDSDeployment 
 
#Run Powershell against remote servers 
invoke-command {install-addsdomaincontroller –domainname ethernuno.intra –credential (get-credential) –computername dc02 
 
#Simplest way of Creating a new Forest 
Install-ADDSForest –DomainName "lab.net" 
 
#Customized Configuration  
Install-ADDSForest –DomainName ‘lab.net’ –CreateDNSDelegation –DomainMode Win2012R2 –ForestMode Win2012R2 –DatabasePath "d:\NTDS" –SYSVOLPath "d:\SYSVOL" –LogPath "e:\Logs"
Install-ADDSForest –DomainName $domain –DomainMode Win2012R2 –ForestMode Win2012R2 -Force -SafeModeAdministratorPassword (convertto-securestring $password -asplaintext -force) –DatabasePath $locationNTDS –SYSVOLPath $locationSYSVOL –LogPath $locationNTDSLogs -verbose

#First you MUST install AD Role on Server
Install-Windowsfeature AD-Domain-Services,DNS

#Join an existing Domain this is the replacment for DCPROMO
Install-ADDSDomainController -DomainName 'awssol.com' -InstallDNS:$True –Credential (Get-Credential) 

#CleanUp commands 
Get-help Uninstall-ADDSDomainController 
 
#Demote Commands 
Uninstall-ADDSDomainController –Forceremoval -Demoteoperationmasterrole 
 
######Set TrustedHost this is required to remotely manage a server when both systems are not apart of a Domain##################### 
Set-Item WSMan:\localhost\Client\TrustedHosts -Value ‘hostname,hostname.local’ –Force 

#Get windows features
Get-Windowsfeature
#Install windows feature
Install-Windowsfeature -Name 'FeatureName' -IncludeAllSubFeature -IncludeManagementTools
Install-Windowsfeature -Name 'FeatureName','FeatureName'

#Disable FireWall You can also do this with a GPO Computer Config>Admin Templates>Network>Network Connections>Windows Firewall
#Advance Firewall settings GPO comouter config>Policies>Windows Swttings>Security Settings>Windows Firewall with Advanced Security
Set-NetFirewallProfile -Profile Domain,Public,Private -Enabled False

#In a virtual environment you will need configure an external time source for your PDC
w32tm.exe /config /manualpeerlist:"0.us.pool.ntp.org 1.us.pool.ntp.org" /syncfromflags:manual /reliable:YES /update
w32tm.exe /config /update
Restart-Service w32time

#Remote Volume Management
#VDS must be running on both the local and remote device, please make certain to open up 'Remote Volume Management' 

#Must register this on each DC so you can move Schema master role
regsvr32 schmmgmt.dll
#Then load mmc.exe and you should now see an options for schema master


################################################################################################################################
Create Bootable USB stick for Server 2012 R2 I will assume this will work for 2016 as well

Pre-requisites: 7-Zip software (Download it from here: http://7-zip.org/), Windows 2012 (R2) ISO (or Windows 8.1 ISO), 8GB or more USB disk

Open Command Prompt in elevated mode (Run as Administrator)
Type diskpart and press Enter
Type list disk and press Enter. Note the list of existing disks.
Insert the USB Disk
Type list disk and press enter again. Note the new disk showed up which is our USB disk. I assume the new disk is 2 for example purpose.
Type select disk X where X is your USB disk. E.g., select disk 2. Press Enter.
Type clean and press enter.
Type create partition primary and press enter to create primary partition 1.
Type select partition 1 and press enter.
Type active and press enter to make the partition 1 active
Type format fs=ntfs and press enter. This will format the partition 1 as NTFS volume.
Type assign and press enter to assign the USB disk to a drive letter.
 

Now right click on Windows Server 2012 R2 or Windows 8.1 ISO file, select 7-Zip –> Extract Files…
Select your USB disk to extract the ISO contents to the USB disk
That’s all. Boot the server or computer using the bootable USB disk.

***Note I simply formatted the USB disk as NTFS in the GUI and then I set the partition as primary
***This also will allow you to upgrade a server instead of doing a clean install
#########################################################################################################################

#####Enable Disk performance metrics under server 2012,windows 10, server 2016, windows 8.1 from command prompt enter
diskperf -Y

###################Windows update tries to update but stops @ updating n%#########################
######This is probably due to a power outage as the VM was doing it's update
##boot into safe mode and run make certain C is the correct drive of your Windows install, in my case it was D
dism.exe /image:D:\ /cleanup-image /revertpendingactions
