######CREATE A SELF-SIGNED CERT WITH SAN(Subject Alternative Name) use in conjunction with openssl.ps1####

##REF:https://www.digitalocean.com/community/tutorials/openssl-essentials-working-with-ssl-certificates-private-keys-and-csrs

##########BEGIN FILE#####################################

[ req ]
default_bits       = 2048
distinguished_name = req_distinguished_name
x509_extensions     = v3_req
prompt             = no
[ req_distinguished_name ]
countryName                 = "US"
stateOrProvinceName         = "Virginia"
localityName                = "Richmond"
organizationName            = "Blah Company"
organizationalUnitName      = "Blah"
commonName                  = "blah.io"
emailAddress                = "blah@blah.io"
[ v3_req ]
keyUsage = keyEncipherment, dataEncipherment
extendedKeyUsage = serverAuth
subjectAltName = @alt_names
[alt_names]
DNS.1 = blah.io
DNS.2 = blah.com
DNS.3 = blah.net


##############END FILE##############################
###REFERENCE https://support.citrix.com/article/CTX135602

##Save the above file with a .cnf extension

##########If you only have one DNS name that's fine but the SAN is now required by Google as of Chrome 58+####
####THANKS GOOGLE!!!!!!!################################################


#####OPENSSL COMMANDS##############################################
##Check to see if our cert is ASCII or BINARY(DER), if you get back text out then it's ASCII
openssl x509 -in cert.crt -text -noout
openssl x509 -in cert.cer -text -noout

##View DER encoded certificates
openssl x509 -in certificate.der -inform der -text -noout

###Verify cert
openssl verify cert.crt

###Good Source material https://serverfault.com/questions/9708/what-is-a-pem-file-and-how-does-it-differ-from-other-openssl-generated-key-file
##https://blog.confirm.ch/adding-a-new-trusted-certificate-authority/


#####Creat a self-signed certificate without generating a CSR first############
openssl req -x509 -newkey rsa:4096 -sha256 -nodes -keyout key.pem -out cert.pem -days 365

openssl req -x509 -newkey rsa:2048 -sha256 -nodes -keyout key.pem -out cert.pem -days 365

##Another option
openssl req -x509 -newkey rsa:4096 -sha256 -nodes -keyout key.key -out cert.crt -days 365

###Option with a SAN .cnf file(note I would recommend this for all certs###############
openssl req -x509 -newkey rsa:4096 -sha256 -nodes -keyout key.key -out cert.crt -days 365 -config path_to_cnf/cert.cnf

####Adding ssl certs ubuntu#######
##Resource: https://askubuntu.com/questions/645818/how-to-install-certificates-for-command-line

##copy .crt file to
sudo cp public.crt /usr/local/share/ca-certificates
sudo update-ca-certificates
##You should see outout 1 added...
#then go to
cd /etc/ssl/certs
##and you should see your cert there
###Note of your file is .pem you should be able to easily just rename it to .crt but I need to test that out
mv cert.pem cert.crt



#############################GENERATE DIFFIE-HELMAN#####################################
openssl dhparam -out dhparams.pem 2048(can also be 1024, 4096 ofcourse higher is better)
#or
openssl dhparam -out /etc/nginx/conf.d/dhparams.pem 2048
####also good source https://weakdh.org/sysadmin.html
###also https://cipherli.st/
####This is a great generator as well from Mozilla: https://mozilla.github.io/server-side-tls/ssl-config-generator/

##nginx add this point to our above generated file#####
ssl_dhparam /etc/nginx/certs/dhparam.pem;

##Generate DH parameters with at least 2048 bits. If you use 4096 bits for your TLS certificate
##you should match it in DH parameters too.
##REF:https://medium.com/@mvuksano/how-to-properly-configure-your-nginx-for-tls-564651438fe0

####Please check your webserver docs to configure DH i.e. apache etc.#####



############INTERCHANGEABLE FILES########################
##For the most part you can rename a .crt to .pem for import into Linux systems(there are exceptions)
##Also you can rename .pfx to .p12 to also import into Linux



##########EXPORT PRIVATE KEY FROM .PFX FILE######################################

##Export private key from pfx file
openssl pkcs12 -in C:\keys\filename.pfx -nocerts -out C:\keys\key.pem
##Make sure you can remember your passwords...

##Extract public key##
openssl pkcs12 -in C:\keys\filename.pfx -clcerts -nokeys -out C:\keys\cert.pem

##Remove password from private key
openssl rsa -in C:\keys\key.pem -out C:\keys\server.pem


###Combine public key and private key into a .PFX file

openssl pkcs12 -export -out certificate.pfx -inkey privateKey.key -in certificate.crt -certfile CACert.crt

##Note the -certfile CACert.crt is optional and references if your have intermediate certificates

##REF: https://serverfault.com/questions/114795/iis7-how-to-import-public-key-and-private-key-as-two-seperate-files

###Convert a DER encoded .cer file to .crt#####
##Note in Windows when you go to export a CA you are given 2 choices, Der encoded or BASE64
##The below is if you selected the first option; I need to see if you select the 2nd choice
##If you can just rename the file from .cer to .crt
openssl x509 -inform DER -in ssl_certificate.cer -out ssl_certificate.crt


###Convert .cer to .pem####
##REF:https://support.aerofs.com/hc/en-us/articles/205007260-How-Do-I-Convert-My-SSL-Certificate-File-To-PEM-Format-
openssl x509 -inform der -in certificate.cer -out certificate.pem

###### -nodes option#######################

-nodes: Create a certificate that does not require a passphrase. If this option is excluded, you will be required 
to enter the passphrase in the console each time the application using it is restarted.

##### more openssl options###################

openssl x509 -in cert.crt(or cert.pem) -noout -text(note this is the public key)



